<html>

<head>
  <title>Demo</title>
</head>

<body background="http://www.straight.com/files/imagecache/homepage_feature/images/featured/100/MOV_Pre_Precious1_2188.jpg">

<!--
<center>
<canvas id="canvas" style="border:1px solid red"></canvas>
</center>
-->

<script>

/*

TODO:
-maybe have it write out canvas tag too? good for pallette
-var indicates local variable: check
-capability of setting background pixels
 (so when pixel is unset it'll go to background pixel)
-rename Screen to Grout
-make demo game
-handle events other than clicks
-make sure pixel positions works when screen is scrolled
-multiple animation loops
-shorthand way of setting foreground/background pixels (set up color pallette then use letters)
  -pallette could be hash of alphanumeric characters
  -then set to string ignoring whitespace
-design way to mess with draw functionality
-use closures to reduce redundancy in code

*/

var Screen = function (params) {
	this.initialize(params);
}

Screen.prototype = {

	initialize:function(params) {

		this.width  = this.merge(params.width, 10);
		this.height = this.merge(params.height, 10);

		this.pixel_width  = this.merge(params.pixel_width, 10);
		this.pixel_height = this.merge(params.pixel_height, 10);

		this.initialize_canvas(params);

		this.pixels = new Array;

		this.clear();
	},

	initialize_canvas:function(params) {

		this.canvas_id = this.merge(params.canvas_id, 'canvas');
		this.canvas    = this.doc_get(this.canvas_id);

		if (!this.canvas) {
			document.write('<canvas id="' + this.canvas_id + '"></canvas>');
			this.canvas    = this.doc_get(this.canvas_id);
		}

		// put reference to this object in canvas
		this.canvas.screen = this

		if (this.canvas.getContext) {  
			this.ctx = this.canvas.getContext('2d');  
		}		
	},

	size_canvas:function() {

		var canvas_width  = this.doc_get(this.canvas_id).getAttribute('width');
		var canvas_height = this.doc_get(this.canvas_id).getAttribute('height');

		var auto_width = (this.width * this.pixel_width);
		if (auto_width != canvas_width) {
			this.doc_get(this.canvas_id).setAttribute('width', auto_width);
		}

		var auto_height = (this.height * this.pixel_height);
		if (auto_height != canvas_height) {
			this.doc_get(this.canvas_id).setAttribute('height', auto_height);
		}
	},

	//
	// Pixel-wrangling
	//

	cycle_through_pixels:function(logic) {

		for (x = 0; x < this.width; x++) {
			for (y = 0; y < this.height; y++) {
				logic(this, x, y);
			}
		}
	},

	clear:function() {

		this.cycle_through_pixels(function(that, x, y) {
				
			if (that.undefined_or_null(that.pixels[x])) {
				that.pixels[x] = Array()
			}

			that.pixels[x][y] = false;
		});
	},

	draw:function() {

		this.size_canvas();

		this.cycle_through_pixels(function(that, x, y) {

			var real_x = x * that.pixel_width;
			var real_y = y * that.pixel_width;

			if (that.pixels[x][y] == true) {

				that.ctx.fillStyle = 'black';
			}
			else if (that.pixels[x][y]) {

				that.ctx.fillStyle = that.pixels[x][y];
			}

			if (that.pixels[x][y]) {

				that.ctx.fillRect(
					real_x,
					real_y,
					that.pixel_width,
					that.pixel_height
				);
			}
			else {
					
				that.ctx.clearRect(
					real_x,
					real_y,
					that.pixel_width,
					that.pixel_height
				);
			}
		});
	},

	// Shorthand for setting pixels:
	// my_screen.poke(1, 4, 'red'); <- set individual pixel to red
	// my_screen.poke([[2, 5], [3, 4, 'green']]); <- set one to black, one to green
	poke:function(x, y, color) {

		// allow x to be a set of points to poke
		if (typeof x == 'object') {

			for (var i in x) {
				this.poke(x[i][0], x[i][1], x[i][2]);
			}
		}
		else {

			if (this.undefined_or_null(color)) {
				color = true;
			}

			this.pixels[x][y] = color;
		}
	},

	toggle:function(x, y, color) {

		// allow x to be a set of points to poke
		if (typeof x == 'object') {

			for (var i in x) {
				this.toggle(x[i][0], x[i][1], x[i][2]);
			}
		}
		else {

			if (this.undefined_or_null(color)) {
				color = true;
			}

			this.pixels[x][y] = this.pixels[x][y] ? false : color;
		}
	},

	//
	// Interaction and animation
	//

	click:function(logic) {

		// store click logic
		this.click_logic = logic;

		// activate click handler
		this.canvas.addEventListener('mousedown', this.click_handler, false);
	},

	click_handler:function(event) {

		// determine x and y in real pixels relative to canvas
		var relative_x = event.clientX - this.offsetLeft;
		var relative_y = event.clientY - this.offsetTop;

		// determine x and y in virtual pixels
		pixel_x = Math.floor(relative_x / this.screen.pixel_width);
		pixel_y = Math.floor(relative_y / this.screen.pixel_height);

		// execute click logic
		this.screen.click_logic(pixel_x, pixel_y);
	},

	animate:function(speed, logic) {

		if (!this.animate_logic) {
			this.animate_logic = logic;
		}

		this.animate_logic();
		this.draw();

		setTimeout('document.getElementById("' + this.canvas_id + '").screen.animate(' + speed + ')', speed);
	},

	//
	// Helpers
	//
	
	doc_get:function(id) {
		return document.getElementById(id);
	},

	merge:function(sent, preset) {
		return (this.undefined_or_null(sent)) ? preset : sent;
	},

	undefined_or_null:function(value) {
		return value == undefined || value == null;
	}
}

function pallette() {

	// http://stackoverflow.com/questions/57803/how-to-convert-decimal-to-hex-in-javascript
	function decimalToHex(d, padding) {

		var hex = Number(d).toString(16);		
		padding = typeof (padding) === "undefined" || padding === null ? padding = 2 : padding;

		while (hex.length < padding) {
			hex = "0" + hex;
		}

		return hex;
	}

	var my_screen = []

    for (r = 0; r < 16; r++) {

		// create new screen
		my_screen[r] = new Screen({
			'canvas_id': 'pallette_' + r,
			'width': 16,
			'height': 16
		});

		for (g = 0; g < 16; g++) {
			for (b = 0; b < 16; b++) {

				red   = decimalToHex(r * 16);
				green = decimalToHex(g * 16);
				blue  = decimalToHex(b * 16);

				color = '#' + red + green + blue;
				//alert(my_screen[r]);
				my_screen[r].pixels[g][b] = color;
			}
		}

		// draw pallette
		my_screen[r].draw();

		// add color display
		document.write('<p><input id="color_' + r + '"></p>');

		// store value of r for reference in click logic
		my_screen[r].r = r;

		// set click logic
		my_screen[r].click(function (x, y) {
			this.doc_get('color_' + this.r).setAttribute('value', this.pixels[x][y]);
		});
    }
}

function demo() {

	// create new screen
	var my_screen = new Screen({
		'width': 5,
		'height': 7
	});
	
	// set some pixels
	my_screen.pixels[1][1] = true;
	my_screen.pixels[3][1] = true;
	my_screen.poke(1, 4);
	my_screen.poke([[2, 5], [3, 4]]);
	my_screen.draw();

	// set click logic
	my_screen.click(function (x, y) {

		// toggle virtual pixel
		this.pixels[x][y] = !this.pixels[x][y];

		// refresh pixel display
		this.draw();
	});

	// animation loop
	my_screen.animate(100, function () {

		// "zoom" in
		this.pixel_height = this.pixel_width = (this.pixel_width < 50) ?
			this.pixel_width + 1 : 1;

		// open mouth in fear
		this.pixels[2][3] = this.pixel_width > 30 ? true : false;

		// flash eyes
		this.pixels[1][1] = this.pixels[3][1] = !this.pixels[3][1];
	});
}

demo();
//pallette()

</script>
</body>
</html>